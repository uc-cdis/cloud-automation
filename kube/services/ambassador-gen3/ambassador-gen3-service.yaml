---
kind: Service
apiVersion: v1
metadata:
  name: ambassador-gen3-service
  annotations:
    service.beta.kubernetes.io/aws-load-balancer-backend-protocol: tcp
    service.beta.kubernetes.io/aws-load-balancer-ssl-ports: "443"
    service.beta.kubernetes.io/aws-load-balancer-ssl-cert: GEN3_ARN
    # supported in k8s 1.9
    service.beta.kubernetes.io/aws-load-balancer-ssl-negotiation-policy: "ELBSecurityPolicy-TLS-1-2-2017-01"
    getambassador.io/config: |
      apiVersion: ambassador/v1
      kind: Module
      name: ambassador
      ambassador_id: "gen3"
      config:
        # see https://www.getambassador.io/reference/core/ambassador/#lua-scripts-lua_scripts
        lua_scripts: |
          function string_split(inputstr, sep)
            if sep == nil then
              sep = "%s"
            end
            local t={}
            for str in string.gmatch(inputstr, "([^"..sep.."]+)") do
              -- print (str)
              table.insert(t, str)
            end
            return t
          end

          function lookup_cookie(cookie_table, cookie_name)
              local i, cookie_item
              for i, cookie_item in ipairs(cookie_table) do
                if string.find(cookie_item, "access_token") ~= nil then
                  return string.gsub(cookie_item, cookie_name .. "=", "")
                end
              end
              return nil
          end

          function handle_auth(request_handle, cookie_table)
            local auth_header = request_handle:headers():get("Authorization")
            if cookie_table ~= nil and auth_header == nil then
              local jwt = lookup_cookie(cookie_table, "access_token")
              if jwt ~= nil then
                local auth = "bearer " .. string.gsub(jwt, "^ ", "")
                request_handle:headers():replace("Authorization", auth)
              end
            end
            return true
          end

          function handle_csrf(request_handle, cookie_table)
            local auth_header = request_handle:headers():get("Authorization")
            local method = request_handle:headers():get(":method")
            if auth_header == nil and (method == "POST" or method == "DELETE" or method == "PUT") then
              -- cookie authenticated update request - verify CSRF
              local csrf_header = request_handle:headers():get("x-csrf-token")
              local csrf_cookie = cookie_lookup("csrftoken")
              if csrf_header ~= nill or csrf_header ~= csrf_cookie then
                request_handle:respond(
                  {[":status"] = "403", ["content-type"] = "application/json"},
                  "{\"error\": \"failed csrf check\"}"
                )
                return false
              end
            end
            return true
          end

          function envoy_on_request(request_handle)
            -- Wait for the entire request body and add a request header with the body size.
            local cookie_header = request_handle:headers():get("Cookie")
            local cookie_table = {}
            if cookie_header ~= nil then
              cookie_table = string_split(cookie_header, ";")
            end
            -- filters - handle CSRF first, as handle_auth modifies headers
            return handle_csrf(request_handle, cookie_table) and handle_auth(request_handle, cookie_table)
          end

spec:
  selector:
    app: ambassador-gen3
  ports:
  - port: 80
    targetPort: 8080
    name: http
  - port: 443
    targetPort: 8080
    name: https
  type: LoadBalancer
