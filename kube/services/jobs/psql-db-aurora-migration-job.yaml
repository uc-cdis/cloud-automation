---
apiVersion: batch/v1
kind: Job
metadata:
  name: psql-db-aurora-migration
spec:
  template:
    metadata:
      labels:
        app: gen3job
    spec:
      affinity:
        nodeAffinity:
          preferredDuringSchedulingIgnoredDuringExecution:
          - weight: 100
            preference:
              matchExpressions:
              - key: karpenter.sh/capacity-type
                operator: In
                values:
                - on-demand
          - weight: 99
            preference:
              matchExpressions:
              - key: eks.amazonaws.com/capacityType
                operator: In
                values:
                - ONDEMAND
      serviceAccountName: psql-db-copy-sa
      containers:
        - name: pgdump
          image: quay.io/cdis/awshelper:master
          imagePullPolicy: Always
          env:
            - name: gen3Env
              valueFrom:
                configMapKeyRef:
                  name: global
                  key: environment
            - name: JENKINS_HOME
              value: "devterm"
            - name: GEN3_HOME
              value: /home/ubuntu/cloud-automation
          command: [ "/bin/bash" ]
          args:
            - "-c"
            - |
              # This job migrates (takes backup and restores) the databases in a Gen3 instance to an Aurora RDS cluster.
              # Requirements:
              # 1. Aurora server credentials should be present in the Gen3Secrets/creds.json with name 'aurora'.
              # 2. Ensure that `gen3 psql aurora` and `gen3 secrets decode aurora-creds` work as expected.
              # 3. The job needs the "psql-db-copy-sa" service account with the necessary permissions to read secrets from all relevant namespaces.

              source "${GEN3_HOME}/gen3/lib/utils.sh"
              gen3_load "gen3/gen3setup"
              namespace=$(cat /var/run/secrets/kubernetes.io/serviceaccount/namespace)
              default_databases=($(echo -e "$(gen3 db services)" | sort -r))
              date_str=$(date -u +%y%m%d_%H%M%S)
              databases=("${default_databases[@]}")
              gen3_log_info "databases: ${databases[@]}"

              # Initialize sheepdog_db_name and failed_migrations variables
              sheepdog_db_name=""
              failed_migrations=""

              # find Aurora Server credentials
              aurora_host_name=$(gen3 secrets decode aurora-creds creds.json | jq -r '.db_host')
              aurora_master_username=$(gen3 secrets decode aurora-creds creds.json | jq -r '.db_username')
              aurora_master_password=$(gen3 secrets decode aurora-creds creds.json | jq -r '.db_password')
              aurora_master_database=$(gen3 secrets decode aurora-creds creds.json | jq -r '.db_database')

              gen3_log_info "Aurora Creds: \n aurora_host_name: $aurora_host_name \n aurora_master_username: $aurora_master_username \n aurora_master_database: $aurora_master_database"

              # Verify important variables are present
              if [ -z "$aurora_host_name" ] || [ -z "$aurora_master_username" ] || [ -z "$aurora_master_password" ] || [ -z "$aurora_master_database" ]; then
                gen3_log_err "Aurora credentials are missing. Exiting."
                exit 1
              fi

              new_resources=""

              # Function to truncate to 63 characters
              function truncate_identifier() {
                local identifier=$1
                if [ ${#identifier} -gt 63 ]; then
                  echo "${identifier:0:63}"
                else
                  echo "$identifier"
                fi
              }

              # Function to create a database with retry logic
              function create_database_with_retry() {
                local db_name=$1
                local retries=5
                local wait_time=10
                for i in $(seq 1 $retries); do
                  PGPASSWORD=${db_password} psql -h $aurora_host_name -U "$db_user" -d postgres -c "CREATE DATABASE $db_name"
                  if [ $? -eq 0 ]; then
                    return 0
                  fi
                  gen3_log_err "Failed to create database $db_name. Retrying in $wait_time seconds..."
                  sleep $wait_time
                done
                return 1
              }

              # Looping through each service to:
              # - Extract the database credentials.
              # - Check if the user already exists, if not, create the user.
              # - Grant required privileges.
              # - Create the database (except for peregrine).
              # - Backup and restore the database on the Aurora Cluster.
              for database in "${databases[@]}"; do
                  for secret_name in "${database}-creds creds.json" "$database-g3auto dbcreds.json"; do
                      creds=$(gen3 secrets decode $secret_name 2>/dev/null)
                      if [ $? -eq 0 ] && [ ! -z "$creds" ]; then
                          db_hostname=$(echo $creds | jq -r .db_host)
                          db_username=$(echo $creds | jq -r .db_username)
                          db_password=$(echo $creds | jq -r .db_password)
                          db_database=$(echo $creds | jq -r .db_database)
                          gen3_log_info "Creating job for\nDatabase: $database, Host: $db_hostname, User: $db_username, Database: $db_database"
                          gen3 job run db-copy DB_HOSTNAME $db_hostname DB_USERNAME $db_username DB_PASSWORD $db_password DB_DATABASE $db_database AURORA_HOSTNAME $aurora_hostname
                          break
                      fi
                  done
              while $(kubectl get pods -l job=db-copy-job | grep -v Completed | grep -v NAME) -gt 1; do
                echo "waiting for jobs to complete"
                sleep 60
              done
              echo "jobs completed, compiling master secret"
              kubectl get secrets -l job="copy-job-${date_str}" -o yaml| yq -r '.items[].data."result"' | base64 -d >> migration.txt
              kubectl create secret generic --from-file="psql-aurora-db-migration-${date_str}"=migration.txt
              echo "Secret saved to psql-aurora-db-migration-${date_str}"
      restartPolicy: Never