---
apiVersion: batch/v1
kind: Job
metadata:
  name: config-fence
spec:
  # not yet supported - backOffLimit: 3
  template:
    metadata:
      labels:
        app: gen3job
    spec:
      serviceAccountName: useryaml-job
      volumes:
        - name: shared-data
          emptyDir: {}
        - name: creds-volume
          secret:
            secretName: "fence-creds"
        - name: config-helper
          configMap:
            name: config-helper
      containers:
      - name: fence
        image: quay.io/cdis/fence:master
        imagePullPolicy: Always
        env:
          - name: PYTHONPATH
            value: /var/www/fence
        volumeMounts:
          - name: "creds-volume"
            readOnly: true
            mountPath: "/var/www/fence/creds.json"
            subPath: creds.json
          - name: "config-helper"
            readOnly: true
            mountPath: "/var/www/fence/config_helper.py"
            subPath: config_helper.py
          - name: shared-data
            mountPath: /mnt/shared
        command: ["/bin/bash"]
        args:
          - "-c"
          # Script always succeeds if it runs (echo exits with 0)
          - |
            # install json query helper if necessary ...
            if ! which jq > /dev/null; then
              export DEBIAN_FRONTEND=noninteractive
              sudo -E apt install -y jq
            fi

            echo "generating default fence configuration..."
            python /fence/cfg_help.py create --config_path new-fence-config.yaml

            if [[ -f /var/www/fence/creds.json ]]; then
              echo "injecting creds.json into fence configuration..."
              python /var/www/fence/config_helper.py -i /var/www/fence/creds.json -c new-fence-config.yaml
            else
              echo "ERROR: /var/www/fence/creds.json not found!"
              echo "       Only generating default config..."
            fi

            cp new-fence-config.yaml /mnt/shared/new-fence-config.yaml

      - name: awshelper
        image: quay.io/cdis/awshelper:master
        imagePullPolicy: Always
        volumeMounts:
          - name: shared-data
            mountPath: /mnt/shared
        command: ["/bin/bash"]
        args:
          - "-c"
          - |
            # install json query helper if necessary ...
            if ! which jq > /dev/null; then
              export DEBIAN_FRONTEND=noninteractive
              sudo -E apt install -y jq
            fi

            # wait for other image to generate config
            let count=0
            while [[ ! -f /mnt/shared/new-fence-config.yaml && $count -lt 50 ]]; do
              echo "waiting for /mnt/shared/new-fence-config.yaml"
              sleep 2
              let count=$count+1
            done

            if [[ -f /mnt/shared/new-fence-config.yaml ]]; then
              # load yaml file into secrets
              if kubectl get secrets/fence-config > /dev/null 2>&1; then
                kubectl delete secret fence-config
              fi
              echo "saving fence configuration into fence-config secret..."
              kubectl create secret generic fence-config "--from-file=fence-config.yaml=/mnt/shared/new-fence-config.yaml"
            else
              echo "/mnt/shared/new-fence-config.yaml did not appear within timeout :-("
            fi

      restartPolicy: Never
