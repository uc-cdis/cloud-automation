          location /proxy/ {
              if ($csrf_check !~ ^ok-\S.+$) {
                return 403 "failed csrf check";
              }
              set $authz_resource "/workspace";
              set $authz_method "access";
              set $authz_service "rstudio";
              # be careful - sub-request runs in same context as this request
              auth_request_set $remoteUser $upstream_http_REMOTE_USER;
              auth_request_set $saved_set_cookie $upstream_http_set_cookie;
              auth_request /gen3-authz;

              if ($saved_set_cookie != "") {
                  add_header Set-Cookie $saved_set_cookie always;
              }
              proxy_set_header REMOTE_USER $remoteUser;
              error_page 403 = @errorworkspace;
              proxy_http_version 1.1;
              set $proxy_service  "ambassador";
              set $upstream_ambassador http://ambassador-service.$namespace.svc.cluster.local;
              rewrite ^/proxy/(.*) /$1 break;
              proxy_pass $upstream_ambassador;
          }
