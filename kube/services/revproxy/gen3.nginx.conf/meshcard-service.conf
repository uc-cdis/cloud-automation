
          location /meshcard/ {

            if ($csrf_check !~ ^ok-\S.+$) {
                return 403 "failed csrf check";
              }

              set $authz_resource "/meshcard";
              set $authz_method "create";
              set $authz_service "meshcard";
              # # be careful - sub-request runs in same context as this request
              auth_request_set $remoteUser $upstream_http_REMOTE_USER;
              auth_request_set $saved_set_cookie $upstream_http_set_cookie;
              auth_request /gen3-authz;

              proxy_set_header REMOTE_USER $remoteUser;
              set $proxy_service  "meshcard-service";
              set $upstream http://meshcard-service$des_domain;
              rewrite ^/meshcard/(.*) /$1 break;
              proxy_pass $upstream;
              proxy_redirect http://$host/ https://$host/meshcard/;


              proxy_set_header Authorization "$access_token";
              proxy_set_header Host $host;
              proxy_set_header X-Real-IP $remote_addr;
              proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
              proxy_set_header Upgrade $http_upgrade;
              proxy_set_header Connection $connection_upgrade;
              client_max_body_size 0;
          }
