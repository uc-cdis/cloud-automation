apiVersion: v1
kind: ConfigMap
metadata:
  name: ohdsi-atlas-nginx-webapi
data:
  webapi.conf: |
    resolver kube-dns.kube-system.svc.cluster.local ipv6=off;

    location /WebAPI/ {
        set $proxy_service  "ohdsi-webapi";
        # upstream is written to logs
        set $upstream http://ohdsi-webapi-service.$namespace.svc.cluster.local;
        # rewrite ^/ohdsi-webapi/(.*) /$1 break;
        proxy_pass $upstream;
        proxy_set_header Host atlas.$hostname;
        proxy_redirect http://atlas.$hostname/ https://atlas.$hostname/;
        client_max_body_size 0;
    }
---
apiVersion: v1
kind: ConfigMap
metadata:
  name: ohdsi-atlas-config-local
data:
  config-local.js: |
    define([], function () {
      var configLocal = {};
      // WebAPI
      configLocal.api = {
        name: 'Gen3',
        url: 'https://atlas.$hostname/WebAPI/'
      };
      configLocal.authProviders = [{
        "name": "Fence",
        "url": "user/login/openid",
        "ajax": false,
        "icon": "fa fa-openid"
      }];
      configLocal.cohortComparisonResultsEnabled = false;
      configLocal.userAuthenticationEnabled = true;
      configLocal.plpResultsEnabled = false;
      return configLocal;
    });

    var parentOfThisIframe = window.parent;
    var mouseoverCount = 0;

    console.log("Adding activity event listener...");
    window.addEventListener("mouseover", function(event) {
        mouseoverCount++;
        if (mouseoverCount % 20 == 0 && parentOfThisIframe) {
            console.log("Activity detected. Atlas running in an iframe. Posting 'I'm alive' message...");
            parentOfThisIframe.postMessage("refresh token!", "*");
        mouseoverCount = 0;
        }
    });
