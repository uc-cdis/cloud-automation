# First-time Cogwheel setup in Gen3


## Register an InCommon Service Provider

Refer to the Cogwheel README for instructions. You will need to either be
an InCommon Site Admin or be able to bug one.

If you already ran `gen3 kube-setup-cogwheel` before doing this, the script
will have generated the signing and encryption keys/certs for you and you will
find them in `g3auto/cogwheel`; supply these during registration. On the other
hand, if you made your own keys, you can simply overwrite the ones generated by
`kube-setup-cogwheel`.

## Run setup

`gen3 kube-setup-cogwheel`; find new g3auto folder at `g3auto/cogwheel`.


## Set up client for Fence

When setting up the DB for the first time, `kube-setup-cogwheel` will also
kick off a job to register an OIDC client configured to work with Gen3/Fence.
The client name will be `fence-client`. The redirect URL will be for Fence's
Cognito callback.

You should find your client credentials from the k8s logs from the client
registration job (cogwheel-register-client).
(If you somehow lost the logs, you can also look in the DB.)
Add these creds to your commons Fence config, using the 'cognito' IdP.
The `discovery_url` is
`https://you.planx-pla.net/cogwheel/.well-known/oauth-authorization-server`.


## Update shibboleth2.xml

In `<ApplicationDefaults entityID="">` put the entityID of the SP you just
registered.


## Update manifest

Add a "cogwheel" entry to your "versions" block with the uc-cdis/cogwheel
Quay image.


## Roll

```
gen3 roll cogwheel
```

You will also need Fence, revproxy, Portal, etc.

## Test

Try to log in.


## Miscellaneous notes

#### SSL certs

The Cogwheel README mentions setting up a TLS/SSL certificate for your domain
name. When deploying with Gen3 this is *not* necessary because of the revproxy.
You do not need an `ssl_cert.pem` and `ssl_key.pem` in your `g3auto` folder.

#### Database setup

You may end up having your indexd db server be randomly selected for the
new db, and you may find a funny-looking `index_record_g_ace` table sitting in
your new db with some moldy potato chips atop. This is not intended and is
probably some legacy gen3 artefact. You may want instead to look
at your server farm and find your Fence server, and then specify that, e.g.
`gen3 db setup cogwheel server1`. Either way, even with this table there,
things will work. You can drop the database manually and start over; if
you do, remember to drop the new `cogwheel_yournamespace` user as well. Don't
use your indexd creds to drop just the table--it's shared between DBs!

#### Client registration

If you are trying to register a client manually (outside the normal first
time setup), you can use
```
gen3 job run cogwheel-register-client
```
You should do a `gen3 secrets sync` before doing this to make sure the pod can
find the db creds.
